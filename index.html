<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kewangan & Faraid Keluarga (V3.2)</title>
    
    <style>
        /* --- STYLE UTAMA --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        h2 { color: #2c3e50; font-size: 20px; } 
        h3 { color: #2c3e50; margin-top: 30px; border-bottom: 2px solid #ddd; padding-bottom: 5px; font-size: 16px;}
        
        /* Input & Forms */
        .input-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; } 
        label { font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Buttons */
        button { padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; transition: 0.2s; font-size: 14px;}
        button:hover { opacity: 0.9; }
        .btn-add { background-color: #27ae60; color: white; } 
        .btn-export { background-color: #2e86c1; color: white; } 
        .btn-pdf { background-color: #8e44ad; color: white; }
        .btn-faraid-pdf { background-color: #d35400; color: white; } 
        .btn-logout { background-color: #c0392b; color: white; float: right; margin-bottom: 20px; }
        .btn-login { background-color: #4285F4; color: white; font-size: 16px; padding: 15px 30px; width: 100%; }

        /* Tables */
        .table-wrapper { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;}
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; } 
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background-color: #2c3e50; color: white; text-align: center; white-space: nowrap; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; } 
        
        /* WARNA KOLUM (GELAP) */
        .col-date { text-align: center; background-color: #222; width: 100px; font-weight: bold; color: white;} 
        .col-cat { text-align: center; background-color: #eaf2f8; color: #2471a3;}
        .col-masuk { background-color: #e8f8f5; font-weight: bold; color: green; } 
        .col-keluar { background-color: #fdedec; font-weight: bold; color: red; } 
        .col-baki { background-color: #fff3cd; font-weight: bold; color: #000;} 
        
        .col-kos { background-color: #eaecee; color: #555; width: 100px; } 
        .col-pusaka { background-color: #a9cce3; border-left: 2px solid #333; font-weight: bold; } 
        .col-waris { background-color: #222; color: white; border: 1px solid #555; } /* Header Gelap */

        /* Input Key-In */
        .input-kos { 
            width: 80px; text-align: right; border: 1px solid #ccc; 
            padding: 5px; border-radius: 3px; font-weight: bold; color: #c0392b;
        }
        .input-kos:focus { border-color: #2980b9; outline: none; background: #eaf2f8; }
        
        .share-fraction { display: block; font-size: 9px; opacity: 0.8; margin-top: 2px; font-weight: normal; color: #ccc; }
        
        .pic-ijat { background-color: #d4e6f1; color: #154360; font-weight: bold; border-left: 2px solid #000; } 
        .pic-ena { background-color: #fadbd8; color: #78281f; font-weight: bold; border-left: 2px solid #000; }
        
        /* New Section Colors */
        .col-mak-total { background-color: #d1f2eb; font-weight: bold; color: #0e6251; border-right: 2px solid #000; }
        .col-anak-mak { background-color: #fff8e1; color: #795548; font-weight: bold; }

        .summary-box { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; }
        .maintenance-box { background: #eaf2f8; padding: 20px; border-radius: 8px; border: 1px solid #d6eaf8; width: 100%; max-width: 500px; }
        .maintenance-row { display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding: 8px 0; }
        .maintenance-total { font-weight: bold; font-size: 16px; color: #2c3e50; border-top: 2px solid #000; border-bottom: none; margin-top: 10px; }

        /* Mobile Responsive */
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .input-container { flex-direction: column; align-items: stretch; gap: 15px; }
            .form-group input, .form-group select { width: 100% !important; box-sizing: border-box; }
            .btn-add, .btn-export, .btn-pdf, .btn-faraid-pdf { width: 100%; padding: 15px; font-size: 16px; margin: 5px 0; }
            #faraidControls { flex-direction: column; gap: 10px; }
            .maintenance-box { width: auto; }
        }

        #loginContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ecf0f1; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        #mainApp { display: none; } 
        #customSlipArea { display: none; }

        /* PRINT LOGIC */
        @media print {
            .btn-logout, #loginContainer, .input-container, .btn-clear, .summary-box, .btn-pdf, .btn-export, .btn-add, button, #faraidControls { display: none !important; }
            @page { size: landscape; margin: 10mm; } 
            body { zoom: 100%; padding: 0; background: white; }
            .table-wrapper, .summary-wrapper, .maintenance-box { box-shadow: none; border: 1px solid #000; overflow: visible; margin-bottom: 10px; page-break-inside: avoid; }
            table { min-width: auto; width: 100%; font-size: 11pt; }
            .input-kos { border: none; background: transparent; text-align: right; width: auto; padding: 0; }
            
            body.print-slip-mode #mainApp { display: none !important; }
            body.print-slip-mode #customSlipArea { 
                display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999;
            }
            .slip-card { border: 2px solid #000; padding: 20px; margin-top: 20px; width: 90%; max-width: 700px; margin-left: auto; margin-right: auto; background: white; }
            .slip-header { text-align: center; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; font-size: 14pt; }
            .slip-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12pt; border-bottom: 1px dotted #ccc; }
            .slip-total { border-top: 2px solid #000; border-bottom: 4px double #000; margin-top: 10px; padding-top: 5px; font-weight: bold; font-size: 13pt; background: #eee; -webkit-print-color-adjust: exact;}
            
            @page { size: auto; margin: 5mm; } 
        }
    </style>
</head>
<body>

    <div id="loginContainer">
        <h2 style="margin-bottom: 20px;">Sistem Faraid Keluarga</h2>
        <p style="margin-bottom: 30px; color: #666; text-align: center;">Sila login menggunakan Google.<br>Pastikan internet laju.</p>
        <button class="btn-login" onclick="window.loginGoogle()">üîê Login Google</button>
        <p id="loginMsg" style="color: red; margin-top: 15px; text-align: center;"></p>
    </div>

    <div id="mainApp">
        <button class="btn-logout" onclick="window.logout()">Log Keluar</button>
        <h2>Sistem Kewangan & Faraid Keluarga (V3.2)</h2>
        
        <div class="input-container">
            <div class="form-group"><label>Tarikh</label><input type="date" id="inputDate"></div>
            <div class="form-group"><label>Kategori</label>
                <select id="inputCategory" onchange="toggleFeldaInput()">
                    <option value="Hasil Kebun">Hasil Kebun</option>
                    <option value="Selenggara">Selenggara</option>
                    <option value="Lain-lain">Lain-lain</option>
                </select>
            </div>
            <div class="form-group"><label>Tarikh Resit Felda</label><input type="date" id="inputFeldaDate"></div>
            <div class="form-group"><label>Catatan</label><input type="text" id="inputDesc" placeholder="Contoh: Jualan Durian"></div>
            <div class="form-group"><label>Lampiran</label><input type="file" id="inputFile" accept="image/*,application/pdf"></div>
            
            <div class="form-group"><label>MASUK (RM)</label><input type="number" id="inputMasuk" placeholder="0.00" oninput="toggleInput('masuk')"></div>
            <div class="form-group"><label>KELUAR (RM)</label><input type="number" id="inputKeluar" placeholder="0.00" oninput="toggleInput('keluar')"></div>
            
            <button class="btn-add" onclick="window.addData()">+ Tambah Data</button>
            <button class="btn-export" onclick="downloadExcelXML()">Download Excel</button>
            <button class="btn-pdf" onclick="window.print()">üñ®Ô∏è Cetak Semua Rekod</button>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th class="col-date">Tarikh</th><th class="col-cat">Kategori</th><th class="col-felda">Tarikh Resit<br>Felda</th><th class="col-desc">Catatan</th>
                        <th class="col-masuk">Masuk</th><th class="col-keluar">Keluar</th><th class="col-baki">Baki</th>
                        <th class="col-attach">Lampiran</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"><tr><td colspan="9" style="text-align:center">Sedang memuatkan data...</td></tr></tbody>
            </table>
        </div>

        <h3>1. Ringkasan Kos (Key-In Manual)</h3>
        <div class="summary-wrapper">
            <table class="summary-table">
                <thead>
                    <tr><th rowspan="2">Bulan</th><th rowspan="2" class="col-sum-masuk">Jumlah Masuk</th><th colspan="4" style="background:#555">Tolakan Kos (Manual)</th><th rowspan="2" class="col-pusaka">Mak (1/2)</th><th rowspan="2" class="col-pusaka">Pusaka (1/2)</th></tr>
                    <tr>
                        <th class="col-kos">Wak Aji (Key In)</th>
                        <th class="col-kos">20% Selenggara</th>
                        <th class="col-kos">Bil / Upah (Key In)</th>
                        <th class="col-clean">Bersih</th>
                    </tr>
                </thead>
                <tbody id="summaryBodyCost"></tbody>
            </table>
        </div>

        <div id="faraidSection">
            <div id="faraidControls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background: #e8f6f3; padding: 10px; border-radius: 5px; border: 1px solid #d1f2eb;">
                <h3 style="margin:0; border:none; padding:0; font-size:16px;">2. Slip Agihan Faraid</h3>
                <div style="display:flex; gap: 5px; align-items: center; flex-wrap:wrap;">
                    <label style="margin:0;">Pilih Bulan:</label>
                    <input type="month" id="slipMonthInput" style="padding: 5px;">
                    <button class="btn-faraid-pdf" onclick="printCustomSlip()">üìÑ Cetak Slip</button>
                </div>
            </div>
            
            <div class="summary-wrapper">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="background:#333; color:white;">Bulan</th>
                            <th colspan="8" style="background:#444; color:white; text-align:center;">Bahagian Waris (Penyebut: 2304)</th>
                            <th rowspan="2" class="pic-ijat">PIC IJAT<br><span style="font-weight:normal; font-size:9px">(Mak+Group A)</span></th>
                            <th rowspan="2" class="pic-ena">PIC ENA<br><span style="font-weight:normal; font-size:9px">(Group B)</span></th>
                        </tr>
                        <tr>
                            <th class="col-waris">Mak<span class="share-fraction">400</span></th>
                            <th class="col-waris">Yati<span class="share-fraction">336</span></th>
                            <th class="col-waris">Ela<span class="share-fraction">336</span></th>
                            <th class="col-waris">Ijat<span class="share-fraction">672</span></th>
                            <th class="col-waris">Ina<span class="share-fraction">84</span></th>
                            <th class="col-waris">Pah<span class="share-fraction">119</span></th>
                            <th class="col-waris">Kila<span class="share-fraction">119</span></th>
                            <th class="col-waris">Ayed<span class="share-fraction">238</span></th>
                        </tr>
                    </thead>
                    <tbody id="summaryBodyDist"></tbody>
                </table>
            </div>
        </div>

        <h3>3. Rekod Selenggara Kebun</h3>
        <div class="maintenance-box">
            <div class="maintenance-row">
                <span>(a) Dana Selenggara Terkumpul (20% Dari Hasil)</span>
                <span style="color:green; font-weight:bold" id="danaTerkumpulDisplay">RM 0.00</span>
            </div>
            <div class="maintenance-row">
                <span>(b) Jumlah Bayaran Selenggara Kebun (Telah Diguna)</span>
                <span style="color:red; font-weight:bold" id="bayaranSelenggaraDisplay">RM 0.00</span>
            </div>
            <div class="maintenance-row maintenance-total">
                <span>(c) Baki Duit Selenggara (a - b)</span>
                <span style="color:blue" id="bakiSelenggaraDisplay">RM 0.00</span>
            </div>
        </div>

        <h3>4. Simulasi Faraid Harta Mak (Jika Berlaku Kematian)</h3>
        <div class="summary-wrapper">
            <table class="summary-table">
                <thead>
                    <tr>
                        <th class="col-date">Bulan</th>
                        <th class="col-mak-total">Harta Mak (RM)<br><span style="font-size:10px; font-weight:normal">(1/2 Harta + 400/2304)</span></th>
                        <th class="col-anak-mak">Ijat (1/2)</th>
                        <th class="col-anak-mak">Yati (1/4)</th>
                        <th class="col-anak-mak">Ela (1/4)</th>
                    </tr>
                </thead>
                <tbody id="summaryMakFaraid"></tbody>
            </table>
        </div>

        <div class="summary-box">
            <strong>Status:</strong> Log masuk sebagai <span id="userEmailDisplay" style="font-weight:bold; color:blue;"></span>.
        </div>
    </div>

    <div id="customSlipArea"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAaGpKuDs8d3-n5ulueMUInoZhxSRkQXWY",
            authDomain: "myfaraid.firebaseapp.com",
            projectId: "myfaraid",
            storageBucket: "myfaraid.firebasestorage.app",
            messagingSenderId: "1077346668678",
            appId: "1:1077346668678:web:d85d5dde3dc9c743f10107"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const tablesCollection = collection(db, "transaksi_faraid");
        const costsCollection = collection(db, "kos_bulanan_faraid"); 

        const allowedEmails = ["isye99@gmail.com", "sysuhaila@gmail.com"];
        let unsubscribeSnapshot = null;
        let unsubscribeCosts = null;

        window.globalRecords = [];
        window.globalCosts = {}; 

        window.loginGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                if (!allowedEmails.includes(result.user.email)) {
                    document.getElementById('loginMsg').innerText = "Maaf, email ini tiada akses.";
                    await signOut(auth);
                }
            } catch (error) { console.error(error); alert("Login Error: " + error.message); }
        };

        window.logout = async () => {
            if(confirm("Log Keluar?")) {
                if(unsubscribeSnapshot) unsubscribeSnapshot();
                if(unsubscribeCosts) unsubscribeCosts();
                await signOut(auth);
            }
        };

        onAuthStateChanged(auth, user => {
            const loginDiv = document.getElementById("loginContainer");
            const appDiv = document.getElementById("mainApp");
            if (user && allowedEmails.includes(user.email)) {
                loginDiv.style.display = "none";
                appDiv.style.display = "block";
                document.getElementById('userEmailDisplay').innerText = user.email;
                initApp();
            } else {
                loginDiv.style.display = "flex";
                appDiv.style.display = "none";
            }
        });

        function initApp() {
            const q = query(tablesCollection, orderBy("timestamp", "asc"));
            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                let records = [];
                snapshot.forEach((doc) => { records.push({ id: doc.id, ...doc.data() }); });
                window.globalRecords = records;
                renderAll(); 
            }, (error) => { alert("Gagal membaca data transaksi."); });

            unsubscribeCosts = onSnapshot(costsCollection, (snapshot) => {
                let costs = {};
                snapshot.forEach((doc) => { costs[doc.id] = doc.data(); });
                window.globalCosts = costs;
                renderAll(); 
            });
        }

        function renderAll() {
            if(!window.globalRecords) return;
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            let bal = 0;
            window.globalRecords.forEach((r) => {
                bal += parseFloat(r.masuk) - parseFloat(r.keluar);
                let attach = r.fileURL ? `<a href="${r.fileURL}" target="_blank" style="color:blue">Fail</a>` : '-';
                tbody.innerHTML += `<tr>
                    <td class="col-date">${r.date}</td>
                    <td class="col-cat">${r.category}</td>
                    <td class="col-felda">${r.feldaDate || '-'}</td>
                    <td class="col-desc">${r.desc}</td>
                    <td class="col-masuk">${r.masuk>0?r.masuk.toFixed(2):'-'}</td>
                    <td class="col-keluar">${r.keluar>0?r.keluar.toFixed(2):'-'}</td>
                    <td class="col-baki">${bal.toFixed(2)}</td>
                    <td class="col-attach">${attach}</td>
                    <td style="text-align:center"><button onclick="deleteRow('${r.id}')" style="background:red; color:white; font-size:10px;">X</button></td>
                </tr>`;
            });

            window.globalSummaryData = generateSummaryData(window.globalRecords, window.globalCosts);
            renderSummary(window.globalSummaryData);
            renderMaintenanceSection();
            renderMakFaraid(window.globalSummaryData); // NEW FUNCTION FOR SECTION 4
        }

        function renderMaintenanceSection() {
            let totalDana = 0;
            if(window.globalSummaryData) {
                window.globalSummaryData.forEach(d => { totalDana += d.selenggara; });
            }
            let totalBayaran = 0;
            if(window.globalRecords) {
                window.globalRecords.forEach(r => {
                    if (r.category === 'Selenggara' && r.keluar > 0) {
                        totalBayaran += parseFloat(r.keluar);
                    }
                });
            }
            let baki = totalDana - totalBayaran;
            document.getElementById('danaTerkumpulDisplay').innerText = "RM " + totalDana.toFixed(2);
            document.getElementById('bayaranSelenggaraDisplay').innerText = "RM " + totalBayaran.toFixed(2);
            document.getElementById('bakiSelenggaraDisplay').innerText = "RM " + baki.toFixed(2);
        }

        // --- NEW FUNCTION: RENDER SECTION 4 ---
        function renderMakFaraid(data) {
            const tbody = document.getElementById('summaryMakFaraid');
            tbody.innerHTML = '';
            
            data.forEach(d => {
                // Formula: Harta Mak = (1/2 Harta Sepencarian) + (Bahagian Faraid Dia)
                const hartaMak = d.makHalf + d.sMak;
                
                // Agihan jika Mak meninggal
                const ijatShare = hartaMak * 0.5; // 2 Bahagian
                const yatiShare = hartaMak * 0.25; // 1 Bahagian
                const elaShare = hartaMak * 0.25; // 1 Bahagian

                tbody.innerHTML += `<tr>
                    <td>${d.monthName}</td>
                    <td class="col-mak-total">${hartaMak.toFixed(2)}</td>
                    <td class="col-anak-mak">${ijatShare.toFixed(2)}</td>
                    <td class="col-anak-mak">${yatiShare.toFixed(2)}</td>
                    <td class="col-anak-mak">${elaShare.toFixed(2)}</td>
                </tr>`;
            });
        }

        function generateSummaryData(records, costs) {
            let summaryData = {};
            records.forEach(r => {
                if (r.category === 'Hasil Kebun' && r.masuk > 0) {
                    const monthKey = r.date.substring(0, 7); 
                    if (!summaryData[monthKey]) summaryData[monthKey] = 0;
                    summaryData[monthKey] += parseFloat(r.masuk);
                }
            });
            
            let resultList = [];
            Object.keys(summaryData).sort().forEach(monthKey => {
                const totalMasuk = summaryData[monthKey];
                const costData = costs[monthKey] || {};
                const manualWakAji = parseFloat(costData.wakAji) || 0; 
                const manualBilUpah = parseFloat(costData.bilUpah) || 0; 
                
                const selenggara = totalMasuk * 0.20; 
                
                let grossAvailable = totalMasuk - manualWakAji - selenggara;
                let fixedCost = grossAvailable < manualBilUpah ? grossAvailable : manualBilUpah; 
                if(fixedCost < 0) fixedCost = 0;
                
                let bersih = grossAvailable - fixedCost;
                if(bersih < 0) bersih = 0;

                const makHalf = bersih / 2;     
                const pusakaAbah = bersih / 2;  

                const sMak = (400 / 2304) * pusakaAbah;
                const sYati = (336 / 2304) * pusakaAbah;
                const sEla = (336 / 2304) * pusakaAbah;
                const sIjat = (672 / 2304) * pusakaAbah;
                const sIna = (84 / 2304) * pusakaAbah;
                const sPah = (119 / 2304) * pusakaAbah;
                const sKila = (119 / 2304) * pusakaAbah;
                const sAyed = (238 / 2304) * pusakaAbah;

                const picIjat = makHalf + sMak + sYati + sEla + sIjat;
                const picEna = sIna + sPah + sKila + sAyed;
                
                let monthName = monthKey;
                try { monthName = new Date(monthKey + "-01").toLocaleDateString('ms-MY', { year: 'numeric', month: 'long' }); } catch(e) {}

                resultList.push({
                    monthKey, monthName, totalMasuk, 
                    wakAji: manualWakAji, 
                    selenggara, 
                    fixedCost: fixedCost, 
                    displayBilUpah: manualBilUpah, 
                    bersih, makHalf, pusakaAbah,
                    sMak, sYati, sEla, sIjat, sIna, sPah, sKila, sAyed, picIjat, picEna
                });
            });
            return resultList;
        }

        function renderSummary(data) {
            const bodyCost = document.getElementById('summaryBodyCost');
            const bodyDist = document.getElementById('summaryBodyDist');
            bodyCost.innerHTML = ''; bodyDist.innerHTML = '';

            let tMasuk = 0, tWakAji = 0, tSelenggara = 0, tBilUpah = 0, tBersih = 0, tMak = 0, tPusaka = 0;

            data.forEach(d => {
                tMasuk += d.totalMasuk;
                tWakAji += d.wakAji;
                tSelenggara += d.selenggara;
                tBilUpah += d.displayBilUpah; 
                tBersih += d.bersih;
                tMak += d.makHalf;
                tPusaka += d.pusakaAbah;

                bodyCost.innerHTML += `<tr>
                    <td>${d.monthName}</td>
                    <td class="col-sum-masuk">${d.totalMasuk.toFixed(2)}</td>
                    <td class="col-kos">
                        <input type="number" class="input-kos" value="${d.wakAji}" 
                        onchange="window.updateCost('${d.monthKey}', 'wakAji', this.value)">
                    </td>
                    <td class="col-kos">${d.selenggara.toFixed(2)}</td>
                    <td class="col-kos">
                        <input type="number" class="input-kos" value="${d.displayBilUpah}" 
                        onchange="window.updateCost('${d.monthKey}', 'bilUpah', this.value)">
                    </td>
                    <td class="col-clean">${d.bersih.toFixed(2)}</td>
                    <td class="col-pusaka">${d.makHalf.toFixed(2)}</td>
                    <td class="col-pusaka">${d.pusakaAbah.toFixed(2)}</td>
                </tr>`;

                bodyDist.innerHTML += `<tr>
                    <td>${d.monthName}</td>
                    <td class="col-waris">${d.sMak.toFixed(2)}</td>
                    <td class="col-waris">${d.sYati.toFixed(2)}</td>
                    <td class="col-waris">${d.sEla.toFixed(2)}</td>
                    <td class="col-waris">${d.sIjat.toFixed(2)}</td>
                    <td class="col-waris">${d.sIna.toFixed(2)}</td>
                    <td class="col-waris">${d.sPah.toFixed(2)}</td>
                    <td class="col-waris">${d.sKila.toFixed(2)}</td>
                    <td class="col-waris">${d.sAyed.toFixed(2)}</td>
                    <td class="pic-ijat">${d.picIjat.toFixed(2)}</td>
                    <td class="pic-ena">${d.picEna.toFixed(2)}</td>
                </tr>`;
            });

            bodyCost.innerHTML += `
                <tr style="background-color:#2c3e50; color:white; font-weight:bold; border-top: 3px double #fff;">
                    <td style="text-align:center">JUMLAH BESAR</td>
                    <td>${tMasuk.toFixed(2)}</td>
                    <td>${tWakAji.toFixed(2)}</td>
                    <td>${tSelenggara.toFixed(2)}</td>
                    <td>${tBilUpah.toFixed(2)}</td>
                    <td>${tBersih.toFixed(2)}</td>
                    <td>${tMak.toFixed(2)}</td>
                    <td>${tPusaka.toFixed(2)}</td>
                </tr>
            `;
        }

        window.updateCost = async function(monthKey, type, value) {
            const numVal = parseFloat(value) || 0;
            await setDoc(doc(db, "kos_bulanan_faraid", monthKey), { [type]: numVal }, { merge: true });
        }

        window.addData = async function() {
            const btn = document.querySelector('.btn-add');
            btn.innerText = "Uploading..."; btn.disabled = true;

            const date = document.getElementById('inputDate').value;
            const category = document.getElementById('inputCategory').value;
            const feldaDate = document.getElementById('inputFeldaDate').value;
            const desc = document.getElementById('inputDesc').value;
            const fileInput = document.getElementById('inputFile');
            let masuk = parseFloat(document.getElementById('inputMasuk').value) || 0;
            let keluar = parseFloat(document.getElementById('inputKeluar').value) || 0;

            if (!date || (masuk === 0 && keluar === 0)) {
                alert("Isi Tarikh & Amaun."); btn.innerText = "+ Tambah"; btn.disabled = false; return;
            }

            try {
                let fileURL = "";
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const storageRef = ref(storage, 'lampiran/' + Date.now() + "_" + file.name);
                    await uploadBytes(storageRef, file);
                    fileURL = await getDownloadURL(storageRef);
                }

                await addDoc(tablesCollection, {
                    timestamp: Date.now(),
                    date, category, feldaDate, desc, masuk, keluar,
                    fileURL: fileURL,
                    createdBy: auth.currentUser.email
                });
                
                document.getElementById('inputDesc').value = '';
                document.getElementById('inputMasuk').value = '';
                document.getElementById('inputKeluar').value = '';
                document.getElementById('inputFile').value = '';
                alert("Berjaya!");
            } catch (e) { console.error(e); alert("Ralat: " + e.message); }
            btn.innerText = "+ Tambah"; btn.disabled = false;
        }

        window.deleteRow = async function(id) {
            if(confirm("Padam rekod?")) await deleteDoc(doc(db, "transaksi_faraid", id));
        }

        window.printCustomSlip = function() {
            const selectedMonth = document.getElementById('slipMonthInput').value; 
            if (!selectedMonth) { 
                alert("Sila pilih bulan dahulu."); document.getElementById('slipMonthInput').focus(); return; 
            }
            if (!window.globalSummaryData || window.globalSummaryData.length === 0) { alert("Tiada data."); return; }

            const d = window.globalSummaryData.find(item => item.monthKey === selectedMonth);
            if (!d) { alert("Tiada rekod untuk bulan: " + selectedMonth); return; }

            const slipArea = document.getElementById('customSlipArea');
            slipArea.innerHTML = ''; 
            
            const totalGroupA = d.sMak + d.sYati + d.sEla + d.sIjat;

            let slipHtml = `
            <div class="slip-card">
                <div class="slip-header">
                    Penyata Bulanan Agihan Faraid Arwah Abah (Hasil Kebun)<br>
                    Tempoh: ${d.monthName}
                </div>
                <div class="slip-group">
                    <div class="slip-row"><span>Mak (400/2304) :</span><span>RM ${d.sMak.toFixed(2)}</span></div>
                    <div class="slip-row"><span>Yati (336 / 2304) :</span><span>RM ${d.sYati.toFixed(2)}</span></div>
                    <div class="slip-row"><span>Ela (336 / 2304) :</span><span>RM ${d.sEla.toFixed(2)}</span></div>
                    <div class="slip-row"><span>Ijat (672 / 2304) :</span><span>RM ${d.sIjat.toFixed(2)}</span></div>
                    <div class="slip-row slip-total"><span>Jumlah (Group A):</span><span>RM ${totalGroupA.toFixed(2)}</span></div>
                </div>
                <div class="slip-group">
                    <div class="slip-row"><span>Ina (84 / 2304) :</span><span>RM ${d.sIna.toFixed(2)}</span></div>
                    <div class="slip-row"><span>Pah (119 / 2304) :</span><span>RM ${d.sPah.toFixed(2)}</span></div>
                    <div class="slip-row"><span>Kila (119 / 2304) :</span><span>RM ${d.sKila.toFixed(2)}</span></div>
                    <div class="slip-row"><span>Ayed (238 / 2304) :</span><span>RM ${d.sAyed.toFixed(2)}</span></div>
                    <div class="slip-row slip-total"><span>Jumlah (Group B):</span><span>RM ${d.picEna.toFixed(2)}</span></div>
                </div>
                <div style="margin-top:20px; text-align:center; font-size:10px; color:#555;">*Dicetak pada: ${new Date().toLocaleString()}</div>
            </div>`;
            slipArea.innerHTML = slipHtml;
            document.body.classList.add('print-slip-mode');
            setTimeout(function() {
                window.print();
                setTimeout(function() { document.body.classList.remove('print-slip-mode'); }, 1000);
            }, 500);
        }

        // Helpers
        document.getElementById('inputDate').valueAsDate = new Date();
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('slipMonthInput').value = `${yyyy}-${mm}`;

        window.toggleFeldaInput = function() {
            const cat = document.getElementById('inputCategory').value;
            const felda = document.getElementById('inputFeldaDate');
            felda.disabled = (cat !== 'Hasil Kebun');
            if(cat !== 'Hasil Kebun') { felda.value = ''; felda.style.backgroundColor = '#eee'; } else { felda.style.backgroundColor = '#fff'; }
        }
        window.toggleInput = function(type) {
            if(type === 'masuk' && document.getElementById('inputMasuk').value > 0) document.getElementById('inputKeluar').value = '';
            else if (type === 'keluar' && document.getElementById('inputKeluar').value > 0) document.getElementById('inputMasuk').value = '';
        }
        window.toggleFeldaInput();

        window.downloadExcelXML = function() {
            if(!window.globalRecords) { alert("Tiada data."); return; }
            let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Styles><Style ss:ID="sHeader"><Font ss:Bold="1"/></Style></Styles>';
            xml += '<Worksheet ss:Name="Transaksi"><Table><Row>';
            ['Tarikh', 'Kategori', 'Tarikh Felda', 'Catatan', 'Masuk', 'Keluar', 'Baki', 'Link Fail'].forEach(h => xml += `<Cell ss:StyleID="sHeader"><Data ss:Type="String">${h}</Data></Cell>`);
            xml += '</Row>';
            let bal = 0;
            window.globalRecords.forEach(r => {
                bal += parseFloat(r.masuk) - parseFloat(r.keluar);
                xml += `<Row><Cell><Data ss:Type="String">${r.date}</Data></Cell><Cell><Data ss:Type="String">${r.category}</Data></Cell><Cell><Data ss:Type="String">${r.feldaDate||''}</Data></Cell><Cell><Data ss:Type="String">${r.desc}</Data></Cell><Cell><Data ss:Type="Number">${r.masuk}</Data></Cell><Cell><Data ss:Type="Number">${r.keluar}</Data></Cell><Cell><Data ss:Type="Number">${bal}</Data></Cell><Cell><Data ss:Type="String">${r.fileURL||''}</Data></Cell></Row>`;
            });
            xml += '</Table></Worksheet>';
            xml += '</Workbook>';
            let blob = new Blob([xml], {type: "application/vnd.ms-excel"});
            let link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = "Data_Faraid.xls";
            document.body.appendChild(link);
            link.click(); document.body.removeChild(link);
        }
    </script>
</body>
</html>
